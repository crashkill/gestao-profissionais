# ğŸš€ GitLab CI/CD - GestÃ£o Profissional HITSS
# ConfiguraÃ§Ã£o para build e deploy automatizado

stages:
  - build
  - test
  - deploy

variables:
  NODE_VERSION: "18"
  CACHE_KEY: "node-modules-$CI_COMMIT_REF_SLUG"

# Cache para acelerar builds
cache:
  key: $CACHE_KEY
  paths:
    - node_modules/
    - .npm/

# Stage 1: Build
build:
  stage: build
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ”¨ Iniciando build do projeto..."
    - npm run build
    - echo "âœ… Build concluÃ­do com sucesso!"
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
    reports:
      dotenv: build.env
  only:
    - main
    - develop
    - merge_requests

# Stage 2: Testes (opcional)
test:
  stage: test
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ§ª Executando testes..."
    - npm run test || echo "âš ï¸ Testes nÃ£o configurados ainda"
    - echo "âœ… Testes concluÃ­dos!"
  only:
    - main
    - develop
    - merge_requests

# Stage 3: Deploy para Staging
deploy:staging:
  stage: deploy
  image: node:$NODE_VERSION-alpine
  script:
    - echo "ğŸš€ Deploy para ambiente de staging..."
    - echo "ğŸ“¦ Artefatos prontos em dist/"
    - ls -la dist/
    - echo "âœ… Deploy de staging concluÃ­do!"
  environment:
    name: staging
    url: https://staging.gestao-profissional.globalhitss.com
  only:
    - develop
  when: manual

# Stage 4: Deploy para ProduÃ§Ã£o
deploy:production:
  stage: deploy
  image: node:$NODE_VERSION-alpine
  script:
    - echo "ğŸš€ Deploy para ambiente de produÃ§Ã£o..."
    - echo "ğŸ“¦ Artefatos prontos em dist/"
    - ls -la dist/
    - echo "ğŸ” Verificando variÃ¡veis de ambiente..."
    - echo "SUPABASE_URL configurada:" $([ -n "$VITE_SUPABASE_URL" ] && echo "âœ…" || echo "âŒ")
    - echo "SUPABASE_KEY configurada:" $([ -n "$VITE_SUPABASE_ANON_KEY" ] && echo "âœ…" || echo "âŒ")
    - echo "âœ… Deploy de produÃ§Ã£o concluÃ­do!"
  environment:
    name: production
    url: https://gestao-profissional.globalhitss.com
  only:
    - main
  when: manual

# Job para limpeza de cache (manual)
clear:cache:
  stage: build
  image: alpine:latest
  script:
    - echo "ğŸ§¹ Limpando cache..."
    - rm -rf node_modules/ .npm/
    - echo "âœ… Cache limpo!"
  when: manual
  allow_failure: true

# Job para gerar relatÃ³rio de dependÃªncias
dependencies:report:
  stage: build
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ“‹ Gerando relatÃ³rio de dependÃªncias..."
    - npm audit --audit-level=moderate
    - npm list --depth=0 > dependencies.txt
    - echo "âœ… RelatÃ³rio gerado!"
  artifacts:
    paths:
      - dependencies.txt
    expire_in: 1 week
  only:
    - main
  when: manual 