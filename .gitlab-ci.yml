# ğŸš€ GitLab CI/CD - Talent Sphere Registry
# Pipeline multi-ambiente: desenvolvimento â†’ homologaÃ§Ã£o â†’ produÃ§Ã£o

stages:
  - security
  - build
  - test
  - deploy

variables:
  NODE_VERSION: "20"
  CACHE_KEY: "node-modules-$CI_COMMIT_REF_SLUG"
  
  # ConfiguraÃ§Ãµes de ambiente
  HOMOLOG_SUPABASE_URL: "https://zbiivgtdamejiwcabmcv.supabase.co"
  PROD_SUPABASE_URL: "https://pwksgdjjkryqryqrvyja.supabase.co"

# Cache para acelerar builds
cache:
  key: $CACHE_KEY
  paths:
    - node_modules/
    - .npm/

# Stage 0: VerificaÃ§Ãµes de SeguranÃ§a
security:audit:
  stage: security
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ”’ Executando auditoria de seguranÃ§a..."
    - npm audit --audit-level=moderate
    - echo "âœ… Auditoria de seguranÃ§a aprovada!"
  only:
    - main
    - develop
    - merge_requests

security:lint:
  stage: security
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ§¹ Verificando qualidade do cÃ³digo..."
    - npm run lint
    - echo "âœ… Lint aprovado!"
  only:
    - main
    - develop
    - merge_requests

# Stage 1: Build para Desenvolvimento
build:development:
  stage: build
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ’» Build para desenvolvimento..."
    - npm run env:dev
    - npm run build:dev
    - echo "âœ… Build de desenvolvimento concluÃ­do!"
  artifacts:
    paths:
      - dist/
    expire_in: 30 minutes
    name: "build-development-$CI_COMMIT_SHORT_SHA"
  only:
    - develop
    - feature/*

# Stage 1: Build para HomologaÃ§Ã£o
build:homologacao:
  stage: build
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ§ª Build para homologaÃ§Ã£o..."
    - npm run env:homolog
    - npm run build:homologacao
    - echo "âœ… Build de homologaÃ§Ã£o concluÃ­do!"
  artifacts:
    paths:
      - dist/
    expire_in: 2 hours
    name: "build-homologacao-$CI_COMMIT_SHORT_SHA"
  environment:
    name: homologacao
    url: https://homolog.talent-sphere.com
  only:
    - develop
    - homolog

# Stage 1: Build para ProduÃ§Ã£o
build:producao:
  stage: build
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸš€ Build para produÃ§Ã£o..."
    - npm run env:prod
    - npm run build:producao
    - echo "âœ… Build de produÃ§Ã£o concluÃ­do!"
    - echo "ğŸ“Š Tamanho do build:"
    - du -sh dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
    name: "build-producao-$CI_COMMIT_SHORT_SHA"
  environment:
    name: producao
    url: https://talent-sphere.globalhitss.com
  only:
    - main

# Stage 2: Testes (opcional)
test:
  stage: test
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ§ª Executando testes..."
    - npm run test || echo "âš ï¸ Testes nÃ£o configurados ainda"
    - echo "âœ… Testes concluÃ­dos!"
  only:
    - main
    - develop
    - merge_requests

# Stage 3: Deploy para HomologaÃ§Ã£o
deploy:homologacao:
  stage: deploy
  image: node:$NODE_VERSION-alpine
  dependencies:
    - build:homologacao
  script:
    - echo "ğŸ§ª Deploy para ambiente de homologaÃ§Ã£o..."
    - echo "ğŸ“¦ Verificando artefatos:"
    - ls -la dist/
    - echo "ğŸ” Verificando configuraÃ§Ãµes:"
    - echo "  - Environment: homologacao"
    - echo "  - Supabase URL: $HOMOLOG_SUPABASE_URL"
    - echo "  - Build size: $(du -sh dist/ | cut -f1)"
    - echo "âœ… Deploy de homologaÃ§Ã£o concluÃ­do!"
    - echo ""
    - echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em:"
    - echo "   https://homolog.talent-sphere.com"
  environment:
    name: homologacao
    url: https://homolog.talent-sphere.com
    on_stop: stop:homologacao
  only:
    - develop
    - homolog
  when: manual

# Job para parar ambiente de homologaÃ§Ã£o
stop:homologacao:
  stage: deploy
  image: alpine:latest
  script:
    - echo "ğŸ›‘ Parando ambiente de homologaÃ§Ã£o..."
    - echo "âœ… Ambiente parado!"
  environment:
    name: homologacao
    action: stop
  only:
    - develop
    - homolog
  when: manual

# Stage 4: Deploy para ProduÃ§Ã£o
deploy:producao:
  stage: deploy
  image: node:$NODE_VERSION-alpine
  dependencies:
    - build:producao
  before_script:
    # VerificaÃ§Ãµes extras de seguranÃ§a para produÃ§Ã£o
    - echo "ğŸ”’ Executando verificaÃ§Ãµes finais de produÃ§Ã£o..."
    - |
      if [ -z "$CI_COMMIT_TAG" ] && [ "$CI_COMMIT_REF_NAME" != "main" ]; then
        echo "âŒ Deploy de produÃ§Ã£o sÃ³ Ã© permitido na branch main ou com tags!"
        exit 1
      fi
  script:
    - echo "ğŸš€ Deploy para ambiente de produÃ§Ã£o..."
    - echo "ğŸ“¦ Verificando artefatos de produÃ§Ã£o:"
    - ls -la dist/
    - echo "ğŸ” VerificaÃ§Ãµes finais:"
    - echo "  - Environment: producao"
    - echo "  - Branch: $CI_COMMIT_REF_NAME"
    - echo "  - Commit: $CI_COMMIT_SHA"
    - echo "  - Supabase URL: $PROD_SUPABASE_URL"
    - echo "  - Build size: $(du -sh dist/ | cut -f1)"
    - echo "ğŸ” Verificando variÃ¡veis crÃ­ticas..."
    - |
      if [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
        echo "âŒ VITE_SUPABASE_ANON_KEY nÃ£o configurada!"
        exit 1
      fi
    - echo "âœ… Deploy de produÃ§Ã£o concluÃ­do!"
    - echo ""
    - echo "ğŸ‰ APLICAÃ‡ÃƒO EM PRODUÃ‡ÃƒO:"
    - echo "   https://talent-sphere.globalhitss.com"
  environment:
    name: producao
    url: https://talent-sphere.globalhitss.com
  only:
    - main
    - tags
  when: manual
  
  # Requer aprovaÃ§Ã£o manual para produÃ§Ã£o
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
      allow_failure: false

# Job para limpeza de cache (manual)
clear:cache:
  stage: build
  image: alpine:latest
  script:
    - echo "ğŸ§¹ Limpando cache..."
    - rm -rf node_modules/ .npm/
    - echo "âœ… Cache limpo!"
  when: manual
  allow_failure: true

# Job para gerar relatÃ³rio de dependÃªncias
dependencies:report:
  stage: build
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "ğŸ“‹ Gerando relatÃ³rio de dependÃªncias..."
    - npm audit --audit-level=moderate
    - npm list --depth=0 > dependencies.txt
    - echo "âœ… RelatÃ³rio gerado!"
  artifacts:
    paths:
      - dependencies.txt
    expire_in: 1 week
  only:
    - main
  when: manual 