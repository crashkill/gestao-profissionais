name: ğŸš€ Deploy ProduÃ§Ã£o

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even with warnings'
        required: false
        default: false
        type: boolean

jobs:
  pre-deploy-security:
    name: ğŸ›¡ï¸ Pre-Deploy Security
    runs-on: ubuntu-latest
    outputs:
      security-score: ${{ steps.security-check.outputs.score }}
      deploy-approved: ${{ steps.security-check.outputs.approved }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ğŸ¤« Setup Doppler
      uses: dopplerhq/cli-action
      with:
        token: ${{ secrets.DOPPLER_TOKEN }}
    
    - name: ğŸ” Critical Security Check
      id: security-check
      run: |
        echo "ğŸ” Running critical security checks..."
        
        # Run all security checks
        npm run secure:full-check
        
        # Extract security score
        SCORE=$(npm run secure:validate 2>&1 | grep -o "ğŸ¯ PontuaÃ§Ã£o de SeguranÃ§a: [0-9]*/100" | grep -o "[0-9]*" | head -1)
        echo "score=$SCORE" >> $GITHUB_OUTPUT
        
        # Check if deployment should be approved
        if [ "$SCORE" -ge 90 ]; then
          echo "approved=true" >> $GITHUB_OUTPUT
          echo "âœ… Security score excellent: $SCORE/100"
        elif [ "$SCORE" -ge 80 ]; then
          echo "approved=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ Security score acceptable: $SCORE/100"
        else
          echo "approved=false" >> $GITHUB_OUTPUT
          echo "âŒ Security score too low for production: $SCORE/100"
          if [ "${{ github.event.inputs.force_deploy }}" != "true" ]; then
            exit 1
          fi
        fi
    
    - name: ğŸ” Environment Check
      run: |
        echo "ğŸ” Checking production environment..."
        echo "âœ… Ready for production deployment"

  deploy-production:
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: pre-deploy-security
    if: needs.pre-deploy-security.outputs.deploy-approved == 'true'

    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ğŸ¤« Setup Doppler
      uses: dopplerhq/cli-action
      with:
        token: ${{ secrets.DOPPLER_TOKEN }}
    
    - name: ğŸ” Setup Environment
      run: |
        echo "ğŸ” Setting up production environment..."
        echo "NODE_ENV=production" >> .env.production
    
    - name: ğŸ—ï¸ Build Application
      run: |
        echo "ğŸ—ï¸ Building for production..."
        npm run build:producao
    
    - name: ğŸ§¹ Post-Build Security Scan
      run: |
        echo "ğŸ§¹ Scanning build artifacts..."
        # Ensure no secrets leaked into build
        if grep -r "eyJ[A-Za-z0-9_-]*\." dist/ 2>/dev/null; then
          echo "âŒ JWT tokens found in build artifacts!"
          exit 1
        fi
        if grep -r "sk-[a-zA-Z0-9]" dist/ 2>/dev/null; then
          echo "âŒ API keys found in build artifacts!"
          exit 1
        fi
        echo "âœ… Build artifacts are clean"
    
    - name: ğŸ“Š Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GH_PAGES_TOKEN }}
        publish_dir: ./dist
        keep_files: false # ForÃ§a a limpeza de arquivos antigos no deploy
        cname: ${{ secrets.CUSTOM_DOMAIN }}
        commit_message: 'ğŸš€ Deploy: ${{ github.sha }}'
    
    - name: ğŸ” Post-Deploy Verification
      run: |
        echo "ğŸ” Verifying deployment..."
        # Wait a bit for deployment to propagate
        sleep 30
        
        # Check if site is responding
        DEPLOY_URL="https://${{ github.repository_owner }}.github.io/Gestao-Profissional"
        curl -f "$DEPLOY_URL" || {
          echo "âŒ Deployment verification failed"
          exit 1
        }
        echo "âœ… Deployment verified successfully"
    
    - name: ğŸ“ Deployment Report
      if: always()
      run: |
        echo "## ğŸš€ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Score**: ${{ needs.pre-deploy-security.outputs.security-score }}/100" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        echo "- **Verification**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://${{ github.repository_owner }}.github.io/Gestao-Profissional" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [pre-deploy-security, deploy-production]
    if: always()
    
    steps:
    - name: ğŸ“¢ Success Notification
      if: needs.deploy-production.result == 'success'
      run: |
        echo "ğŸ‰ Production deployment successful!"
        echo "Security Score: ${{ needs.pre-deploy-security.outputs.security-score }}/100"
        echo "Commit: ${{ github.sha }}"
    
    - name: ğŸš¨ Failure Notification
      if: needs.deploy-production.result == 'failure'
      run: |
        echo "âŒ Production deployment failed!"
        echo "Please check the logs and security score"
        exit 1 