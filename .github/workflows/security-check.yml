name: ðŸ›¡ï¸ Security Check

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]
  schedule:
    # Run security check every day at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Get full history for secret scanning
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ðŸ“¦ Install Dependencies
      run: npm ci
    
    - name: ðŸ” Secret Scanning
      run: |
        echo "ðŸ” Scanning for exposed secrets..."
        npm run secure:scan
        if [ $? -ne 0 ]; then
          echo "âŒ Secret scan failed!"
          exit 1
        fi
    
    - name: âœ… Environment Check
      run: |
        echo "âœ… Checking environment variables usage..."
        npm run secure:check
    
    - name: ðŸ§ª Security Validation
      run: |
        echo "ðŸ§ª Running security validation..."
        npm run secure:validate
    
    - name: ðŸ“Š Dependency Audit
      run: |
        echo "ðŸ“Š Running dependency audit..."
        npm run secure:audit --audit-level=moderate
        if [ $? -ne 0 ]; then
          echo "âš ï¸ High/Critical vulnerabilities found!"
          echo "Please run 'npm audit fix' to resolve issues"
          # Don't fail the build for audit issues, just warn
        fi
    
    - name: ðŸ—ï¸ Build Test
      run: |
        echo "ðŸ—ï¸ Testing build process..."
        npm run build
        if [ $? -ne 0 ]; then
          echo "âŒ Build failed!"
          exit 1
        fi
    
    - name: ðŸ§¹ Post-Build Security Check
      run: |
        echo "ðŸ§¹ Checking build artifacts..."
        if [ -d "dist" ]; then
          # Check if build artifacts contain any secrets
          grep -r "eyJ[A-Za-z0-9_-]*" dist/ && echo "âŒ JWT found in build!" && exit 1 || echo "âœ… No secrets in build"
          grep -r "sk-[a-zA-Z0-9]" dist/ && echo "âŒ API key found in build!" && exit 1 || echo "âœ… No API keys in build"
        fi
    
    - name: ðŸ“ˆ Security Score
      run: |
        echo "ðŸ“ˆ Calculating security score..."
        SCORE=$(npm run secure:validate 2>&1 | grep -o "ðŸŽ¯ PontuaÃ§Ã£o de SeguranÃ§a: [0-9]*/100" | grep -o "[0-9]*" | head -1)
        echo "Security Score: $SCORE/100"
        if [ "$SCORE" -lt 80 ]; then
          echo "âŒ Security score too low: $SCORE/100"
          echo "Minimum required score: 80/100"
          exit 1
        fi
        echo "âœ… Security score acceptable: $SCORE/100"
    
    - name: ðŸ“ Security Report
      if: always()
      run: |
        echo "ðŸ“ Generating security report..."
        echo "## ðŸ›¡ï¸ Security Check Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Secret Scan**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment Check**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Test**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Dependency Audit**: âš ï¸ Check logs" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Score**: $(npm run secure:validate 2>&1 | grep -o '[0-9]*/100' | head -1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Details" >> $GITHUB_STEP_SUMMARY
        echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY 