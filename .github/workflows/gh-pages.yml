name: ðŸš€ Deploy ProduÃ§Ã£o

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ForÃ§ar deploy mesmo sem mudanÃ§as'
        required: false
        default: false
        type: boolean

# Configura as permissÃµes do job
permissions:
  contents: read
  pages: write
  id-token: write

# Permite que o job atualize o job de deploy
concurrency:
  group: 'production'
  cancel-in-progress: false # NÃ£o cancela deploys de produÃ§Ã£o

jobs:
  security-check:
    name: ðŸ”’ VerificaÃ§Ãµes de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Security Audit
        run: |
          echo "ðŸ”’ Executando auditoria de seguranÃ§a..."
          npm run secure:audit
          echo "âœ… Auditoria concluÃ­da!"

      - name: ðŸ§¹ Lint Code
        run: |
          echo "ðŸ§¹ Verificando qualidade do cÃ³digo..."
          npm run lint
          echo "âœ… Lint aprovado!"

  build-and-deploy:
    name: ðŸ—ï¸ Build e Deploy ProduÃ§Ã£o
    runs-on: ubuntu-latest
    needs: security-check
    
    steps:
      - name: ðŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          npm run update:browserslist || echo "Warning: browserslist update failed, continuing..."

      - name: ðŸ”§ Setup Production Environment
        run: |
          echo "ðŸš€ Preparando ambiente de produÃ§Ã£o..."
          echo "NODE_ENV=production" > .env.production
          echo "âœ… Ambiente configurado!"

      - name: ðŸ—ï¸ Build application
        run: |
          echo "ðŸ”¨ Building application for production..."
          npm run build:local
        env:
          # Supabase - ProduÃ§Ã£o
          VITE_SUPABASE_URL: https://pwksgdjjkryqryqrvyja.supabase.co
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          
          # Ambiente
          VITE_ENVIRONMENT: producao
          VITE_APP_TITLE: Talent Sphere - HITSS
          VITE_DEBUG_MODE: false
          
          # APIs de Terceiros (versÃµes de produÃ§Ã£o)
          VITE_TOGETHER_API_KEY: ${{ secrets.VITE_TOGETHER_API_KEY }}
          VITE_GROQ_API_KEY: ${{ secrets.VITE_GROQ_API_KEY }}

      - name: âœ… Verify build output
        run: |
          echo "ðŸ” Verificando build output..."
          if [ ! -f dist/index.html ]; then
            echo "âŒ Error: index.html not found in dist/"
            ls -la dist/ || true
            exit 1
          fi
          echo "âœ… Build verified successfully"
          echo "ðŸ“Š Production build size:"
          du -sh dist/

      - name: ðŸ” Production Health Check
        run: |
          echo "ðŸ¥ Executando verificaÃ§Ãµes de produÃ§Ã£o..."
          # Verifica se nÃ£o hÃ¡ console.logs em produÃ§Ã£o
          if grep -r "console\.log" dist/ --exclude-dir=node_modules; then
            echo "âš ï¸ Warning: console.log encontrado no build de produÃ§Ã£o"
          fi
          echo "âœ… Health check concluÃ­do!"

      - name: ðŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: ðŸ“Š Generate Production Report
        run: |
          echo "ðŸ“Š Generating production report..."
          cat > production-report.md << EOF
          # ðŸš€ RelatÃ³rio de Deploy - ProduÃ§Ã£o
          
          **Branch:** \`${{ github.ref_name }}\`
          **Commit:** \`${{ github.sha }}\`
          **Ambiente:** ProduÃ§Ã£o
          **Data:** $(date)
          
          ## âœ… Status
          - SeguranÃ§a: Aprovado
          - Build: Sucesso
          - Deploy: Em andamento
          
          ## ðŸ“Š MÃ©tricas
          - Tamanho do build: $(du -sh dist/ | cut -f1)
          - Node.js: 20
          - Branches: main
          
          ## ðŸ”— Links
          - [Ver aplicaÃ§Ã£o](https://crashkill.github.io/Gestao-Profissional/)
          - [Logs do build](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

  deploy:
    name: ðŸŒ Deploy GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    needs: build-and-deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist-homologacao
          keep_files: false # ForÃ§a a limpeza de arquivos antigos no deploy
          publish_branch: gh-pages-homologacao # Branch de homologaÃ§Ã£o
          commit_message: "ðŸš€ Deploy HomologaÃ§Ã£o: ${{ github.sha }}"

      - name: ðŸŽ‰ Notify Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deploy de produÃ§Ã£o realizado com sucesso!"
          echo "ðŸš€ Ambiente: ProduÃ§Ã£o"
          echo "ðŸŒ URL: ${{ steps.deployment.outputs.page_url }}"

      - name: âŒ Notify Failure
        if: failure()
        run: |
          echo "âŒ Deploy de produÃ§Ã£o falhou!"
          echo "ðŸ” Verifique os logs para mais detalhes"
          exit 1
